<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA-re9plYFbo2hnpkt1oTwJo4ZHes6WZaU",
        authDomain: "recipebook-fb16b.firebaseapp.com",
        projectId: "recipebook-fb16b",
        storageBucket: "recipebook-fb16b.firebasestorage.app",
        messagingSenderId: "213197710946",
        appId: "1:213197710946:web:f3a05df4fae61ac023933b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let cloudRecipes = [];

    // 1. AUTH WATCHER & PROTECTION
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            const display = document.getElementById('userEmailDisplay');
            if(display) display.innerText = "Logged in as: " + user.email;
            syncCloudRecipes(user.uid);
        } else {
            // REDIRECT: If not logged in, kick back to login page
            window.location.href = 'index.html';
        }
    });

    // 2. LOGOUT FUNCTION (The fix you requested)
    window.handleLogout = async () => {
        try {
            await signOut(auth);
            // Force redirect to login page after sign out
            window.location.href = 'index.html';
        } catch (error) {
            console.error("Logout failed:", error);
            alert("Error signing out.");
        }
    };

    // 3. REAL-TIME SYNC
    function syncCloudRecipes(uid) {
        const q = query(collection(db, "recipes"), where("uid", "==", uid));
        onSnapshot(q, (snapshot) => {
            cloudRecipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            displayRecipes();
        });
    }

    // 4. SAVE / UPDATE
    window.saveRecipeToCloud = async () => {
        const docId = document.getElementById('editDocId').value;
        const data = {
            uid: currentUser.uid,
            name: document.getElementById('recipeName').value,
            folder: document.getElementById('recipeFolderSelect').value,
            ingredients: document.getElementById('recipeIngredients').value,
            steps: document.getElementById('recipeSteps').value,
            cardBg: window.selectedCardColor,
            image: document.getElementById('recipeImageUrl').value || 'https://via.placeholder.com/350x180'
        };

        try {
            if (docId) {
                await updateDoc(doc(db, "recipes", docId), data);
            } else {
                await addDoc(collection(db, "recipes"), data);
            }
            closeModal();
        } catch (e) { alert("Error saving: " + e.message); }
    };

    // 5. DELETE
    window.deleteRecipeFromCloud = async (id) => {
        if (confirm("Delete this recipe forever?")) {
            await deleteDoc(doc(db, "recipes", id));
        }
    };

    // 6. DISPLAY LOGIC
    window.displayRecipes = () => {
        const list = document.getElementById('recipeList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        list.innerHTML = "";
        
        let filtered = window.currentFolder === 'All' ? cloudRecipes : cloudRecipes.filter(r => r.folder === window.currentFolder);
        filtered = filtered.filter(r => r.name.toLowerCase().includes(search));

        filtered.forEach((r) => {
            const stepItems = r.steps.split('\n').filter(s => s.trim() !== "").map(s => `<li>${s}</li>`).join('');
            list.innerHTML += `
                <div class="card" style="background:${r.cardBg}">
                    <img src="${r.image}" class="card-img">
                    <div class="card-body">
                        <h2 style="margin:0;">${r.name}</h2>
                        <div class="section-title">Ingredients</div>
                        <p style="white-space: pre-wrap; font-size:14px;">${r.ingredients}</p>
                        <div class="section-title">Instructions</div>
                        <ol class="steps-list" style="font-size:14px;">${stepItems}</ol>
                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button onclick="openModal('${r.id}')" style="flex:1; cursor:pointer; border:none; background:rgba(0,0,0,0.1); padding:8px; border-radius:5px;">Edit</button>
                            <button onclick="deleteRecipeFromCloud('${r.id}')" style="flex:1; cursor:pointer; border:none; background:rgba(255,0,0,0.1); color:#d32f2f; padding:8px; border-radius:5px;">Delete</button>
                        </div>
                    </div>
                </div>`;
        });
    };

    // UI State Helpers
    window.openModal = (id = "") => {
        document.getElementById('recipeModal').style.display = "block";
        if (id && typeof id === 'string') {
            const r = cloudRecipes.find(x => x.id === id);
            document.getElementById('editDocId').value = id;
            document.getElementById('recipeName').value = r.name;
            document.getElementById('recipeFolderSelect').value = r.folder;
            document.getElementById('recipeIngredients').value = r.ingredients;
            document.getElementById('recipeSteps').value = r.steps;
            document.getElementById('recipeImageUrl').value = r.image;
            window.selectedCardColor = r.cardBg;
        } else {
            document.getElementById('editDocId').value = "";
            document.getElementById('recipeName').value = "";
            document.getElementById('recipeIngredients').value = "";
            document.getElementById('recipeSteps').value = "";
            document.getElementById('recipeImageUrl').value = "";
            window.selectedCardColor = '#ffffff';
        }
        renderCardSwatches();
    };

    window.closeModal = () => document.getElementById('recipeModal').style.display = "none";

    window.filterFolder = (name) => {
        window.currentFolder = name;
        document.getElementById('currentFolderTitle').innerText = name;
        if(window.toggleSidebar) window.toggleSidebar();
        displayRecipes();
    };

    // Initialize UI
    if(window.renderDashSwatches) window.renderDashSwatches();
    if(window.renderFolderUI) window.renderFolderUI();
    document.getElementById('searchInput').addEventListener('keyup', displayRecipes);
</script>
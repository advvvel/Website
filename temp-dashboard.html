<!DOCTYPE html>
<html>
<head>
    <title>Recipe Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #333; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-logout { background: #dc3545; margin-top: 20px; }
        #recipeList { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        .recipe-item { background: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 5px; border-left: 5px solid #28a745; }
    </style>
</head>
<body>

<div class="container">
    <h2>My Recipe Book</h2>
    <p id="userEmail">Loading user...</p>

    <input type="text" id="recipeTitle" placeholder="Recipe Name (e.g. Pasta)">
    <textarea id="recipeIngredients" rows="4" placeholder="Ingredients and steps..."></textarea>
    <button class="btn" onclick="saveRecipe()">Add Recipe to Cloud</button>

    <div id="recipeList">
        <h3>My Saved Recipes</h3>
        <div id="listContent">Loading your recipes...</div>
    </div>

    <button class="btn btn-logout" onclick="handleLogout()">Logout</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // Your Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyA-re9plYFbo2hnpkt1oTwJo4ZHes6WZaU",
        authDomain: "recipebook-fb16b.firebaseapp.com",
        projectId: "recipebook-fb16b",
        storageBucket: "recipebook-fb16b.firebasestorage.app",
        messagingSenderId: "213197710946",
        appId: "1:213197710946:web:f3a05df4fae61ac023933b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // 1. Monitor Auth State
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('userEmail').innerText = "Logged in as: " + user.email;
            loadRecipes(user.uid); // Load recipes once we have the ID
        } else {
            window.location.href = 'index.html'; // Kick out if not logged in
        }
    });

    // 2. Save Recipe to Firestore
    window.saveRecipe = async () => {
        const title = document.getElementById('recipeTitle').value;
        const ingredients = document.getElementById('recipeIngredients').value;

        if (!title || !ingredients) {
            alert("Please fill in both fields!");
            return;
        }

        try {
            await addDoc(collection(db, "recipes"), {
                uid: currentUser.uid,
                title: title,
                ingredients: ingredients,
                timestamp: new Date()
            });
            document.getElementById('recipeTitle').value = "";
            document.getElementById('recipeIngredients').value = "";
            alert("Recipe saved!");
        } catch (e) {
            console.error("Error adding document: ", e);
            alert("Error: Make sure your Firestore Rules are set to 'allow read, write: if request.auth != null;'");
        }
    };

    // 3. Load Recipes in Real-Time
    function loadRecipes(uid) {
        const q = query(collection(db, "recipes"), where("uid", "==", uid));
        
        onSnapshot(q, (snapshot) => {
            const listDiv = document.getElementById('listContent');
            listDiv.innerHTML = ""; // Clear current list
            
            if (snapshot.empty) {
                listDiv.innerHTML = "No recipes saved yet.";
                return;
            }

            snapshot.forEach((doc) => {
                const data = doc.data();
                const item = document.createElement('div');
                item.className = "recipe-item";
                item.innerHTML = `<strong>${data.title}</strong><br><small>${data.ingredients}</small>`;
                listDiv.appendChild(item);
            });
        });
    }

    // 4. Logout Function
    window.handleLogout = () => {
        signOut(auth).then(() => {
            window.location.href = 'index.html';
        });
    };
</script>

</body>
</html>
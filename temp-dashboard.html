<!DOCTYPE html>
<html>
<head>
    <title>RecipeBook Dashboard</title>
    <style>
        :root { 
            --bg-color: #f4f7f6; 
            --main-font: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body { 
            font-family: var(--main-font); 
            background-color: var(--bg-color); 
            margin: 0; 
            min-height: 100vh; 
            transition: background 0.4s ease;
        }

        /* Navbar */
        .navbar { 
            background: white; 
            padding: 15px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: sticky;
            top: 0;
            z-index: 900;
        }
        .navbar h1 { margin: 0; font-size: 24px; color: #333; }

        .search-container { flex-grow: 1; margin: 0 40px; max-width: 500px; }
        .search-input {
            width: 100%; padding: 10px 15px; border: 1px solid #ddd; 
            border-radius: 20px; font-size: 14px; outline: none; 
        }

        /* Sidebar */
        .sidebar { 
            position: fixed; top: 0; right: -320px; width: 300px; height: 100%; 
            background: #222; color: white; padding: 25px; transition: 0.4s ease; 
            z-index: 1001; display: flex; flex-direction: column; box-sizing: border-box;
        }
        .sidebar.active { right: 0; }
        .sidebar-overlay { 
            display: none; position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.5); z-index: 1000; 
        }
        .sidebar-overlay.active { display: block; }

        /* Settings UI */
        .swatch-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .color-swatch { 
            width: 30px; height: 30px; border-radius: 6px; cursor: pointer; 
            border: 2px solid transparent; transition: 0.2s; 
        }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border: 2px solid #007bff; transform: scale(1.1); }
        
        .btn-blue { 
            background: #007bff; color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .btn-save-swatch {
            background: #444; color: white; border: none; padding: 5px 12px; 
            border-radius: 15px; cursor: pointer; font-size: 12px; margin-left: 10px;
        }

        .btn-logout {
            margin-top: auto; width: 100%; padding: 12px; background: #d32f2f;
            color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
        }

        /* Modal & Cards */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto;
        }
        .modal-content { background: white; width: 420px; margin: 20px auto; padding: 30px; border-radius: 15px; position: relative; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; }
        input, textarea, select { width: 100%; margin-top: 5px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

        .main-content { padding: 30px; }
        #recipeList { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 30px; }
        
        /* Updated Neat Card Design with "Tabs" */
        .card { 
            border-radius: 15px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.12); 
            padding: 0; cursor: pointer; transition: transform 0.2s; background: white;
            display: flex; flex-direction: column; border: 1px solid rgba(0,0,0,0.05);
        }
        .card:hover { transform: translateY(-8px); }
        .card-img { width: 100%; height: 200px; object-fit: cover; background: #eee; }
        .card-body { padding: 25px; }
        
        /* Card Sections */
        .recipe-header { border-bottom: 2px solid rgba(0,0,0,0.1); padding-bottom: 10px; margin-bottom: 15px; }
        .recipe-header h3 { margin: 0; color: #111; font-size: 22px; text-transform: capitalize; }
        
        .recipe-section { margin-bottom: 15px; padding-left: 15px; }
        .section-label { font-weight: 800; font-size: 12px; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }
        .section-content { font-size: 14px; color: #333; line-height: 1.6; white-space: pre-wrap; }

        .btn-delete-recipe { background: #ff5c5c; color: white; border: none; padding: 10px; border-radius: 8px; margin-top: 10px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="overlay" onclick="window.toggleSidebar()"></div>
    
    <div class="sidebar" id="sidebar">
        <h2>Settings ⚙️</h2>
        <p id="userEmailDisplay" style="font-size: 12px; color: #aaa;"></p>
        
        <h3>Dashboard Theme</h3>
        <div class="swatch-container" id="dashSwatches"></div>
        <div style="display:flex; align-items:center; margin-top:10px;">
            <input type="color" id="dashColorPicker" style="width:30px; height:30px; border:none; cursor:pointer; background:none;">
            <button class="btn-save-swatch" onclick="window.addNewDashColor()">Save Color</button>
        </div>

        <hr style="margin:25px 0; border:0; border-top:1px solid #444;">
        
        <h3>Folders</h3>
        <div id="folderList"></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="newFolderName" placeholder="Folder name..." style="background:#333; color:white; border:none; padding:8px; border-radius:5px;">
            <button onclick="window.addFolder()" style="cursor:pointer; background:#555; border:none; color:white; padding:0 12px; border-radius:5px;">+</button>
        </div>
        
        <button class="btn-logout" onclick="window.handleLogout()">Sign Out</button>
        <button onclick="window.toggleSidebar()" style="margin-top:10px; width:100%; padding:10px; background:#555; color:white; border:none; border-radius:8px; cursor:pointer;">Close</button>
    </div>

    <div class="navbar">
        <h1>RecipeBook</h1>
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Search and press Enter..." onkeydown="if(event.key === 'Enter') window.displayRecipes()">
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <button class="btn-blue" onclick="window.openModal()">+ Create Recipe</button>
            <button onclick="window.toggleSidebar()" style="background:none; border:none; font-size:24px; cursor:pointer;">⚙️</button>
        </div>
    </div>

    <div class="main-content">
        <h2 id="currentFolderTitle">All Recipes</h2>
        <div id="recipeList">Loading...</div>
    </div>

    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Recipe Info</h2>
            <input type="hidden" id="editDocId">
            <label>Recipe Name</label><input type="text" id="recipeName">
            <label>Image URL</label><input type="text" id="recipeImage" placeholder="Paste image link here...">
            <label>Folder</label><select id="recipeFolderSelect"></select>
            <label>Ingredients</label><textarea id="recipeIngredients" rows="3" placeholder="List ingredients here..."></textarea>
            <label>Instructions</label><textarea id="recipeSteps" rows="4" placeholder="How to make it..."></textarea>
            
            <label>Card Color</label>
            <div class="swatch-container" id="cardSwatches"></div>
            <div style="display:flex; align-items:center; margin-top:10px;">
                <input type="color" id="cardColorPicker" style="width:30px; height:30px; border:none; cursor:pointer; background:none;">
                <button class="btn-save-swatch" onclick="window.addNewCardColor()">Save Choice</button>
            </div>
            
            <button class="btn-blue" onclick="window.saveRecipeToCloud()" style="width:100%; margin-top:20px;">Save Recipe</button>
            <button id="deleteRecipeBtn" class="btn-delete-recipe" style="display:none;" onclick="window.deleteRecipe()">Delete Recipe</button>
            <button onclick="window.closeModal()" style="width:100%; background:none; border:none; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA-re9plYFbo2hnpkt1oTwJo4ZHes6WZaU",
            authDomain: "recipebook-fb16b.firebaseapp.com",
            projectId: "recipebook-fb16b",
            storageBucket: "recipebook-fb16b.firebasestorage.app",
            messagingSenderId: "213197710946",
            appId: "1:213197710946:web:f3a05df4fae61ac023933b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let cloudRecipes = [];

        window.folders = JSON.parse(localStorage.getItem('myFolders')) || [];
        window.dashColors = JSON.parse(localStorage.getItem('dashColors')) || ['#f4f7f6', '#ffecec', '#e3f2fd', '#222222'];
        window.cardColors = JSON.parse(localStorage.getItem('myCardColors')) || ['#ffffff', '#fff9c4', '#c8e6c9', '#ffccbc', '#e1f5fe', '#f3e5f5'];
        window.currentFolder = 'All';
        window.selectedCardColor = '#ffffff';

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmailDisplay').innerText = user.email;
                syncCloudRecipes(user.uid);
            } else {
                window.location.href = 'index.html';
            }
        });

        window.handleLogout = async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        };

        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        };

        window.renderDashSwatches = () => {
            const container = document.getElementById('dashSwatches');
            container.innerHTML = "";
            window.dashColors.forEach(color => {
                const div = document.createElement('div');
                div.className = 'color-swatch';
                div.style.background = color;
                div.onclick = () => document.documentElement.style.setProperty('--bg-color', color);
                container.appendChild(div);
            });
        };

        window.addNewDashColor = () => {
            const color = document.getElementById('dashColorPicker').value;
            if(!window.dashColors.includes(color)) {
                window.dashColors.push(color);
                localStorage.setItem('dashColors', JSON.stringify(window.dashColors));
                window.renderDashSwatches();
            }
        };

        window.addNewCardColor = () => {
            const color = document.getElementById('cardColorPicker').value;
            if(!window.cardColors.includes(color)) {
                window.cardColors.push(color);
                localStorage.setItem('myCardColors', JSON.stringify(window.cardColors));
                window.selectedCardColor = color;
                window.renderCardSwatches();
            }
        };

        window.renderFolderUI = () => {
            const list = document.getElementById('folderList');
            const select = document.getElementById('recipeFolderSelect');
            list.innerHTML = `<div onclick="window.filterFolder('All')" style="cursor:pointer; padding:8px;">All Recipes</div>`;
            select.innerHTML = `<option value="All">All Recipes</option>`;
            window.folders.forEach((f, index) => {
                list.innerHTML += `<div style="padding:8px; display:flex; justify-content:space-between;"><span onclick="window.filterFolder('${f}')" style="cursor:pointer;">${f}</span><span class="delete-folder-btn" onclick="window.deleteFolder(${index})">×</span></div>`;
                select.innerHTML += `<option value="${f}">${f}</option>`;
            });
        };

        window.addFolder = () => {
            const name = document.getElementById('newFolderName').value;
            if (name && !window.folders.includes(name)) {
                window.folders.push(name);
                localStorage.setItem('myFolders', JSON.stringify(window.folders));
                document.getElementById('newFolderName').value = "";
                window.renderFolderUI();
            }
        };

        window.deleteFolder = (index) => {
            if(confirm("Delete this folder?")) {
                window.folders.splice(index, 1);
                localStorage.setItem('myFolders', JSON.stringify(window.folders));
                window.renderFolderUI();
            }
        };

        window.filterFolder = (name) => {
            window.currentFolder = name;
            document.getElementById('currentFolderTitle').innerText = name;
            window.toggleSidebar();
            window.displayRecipes();
        };

        window.renderCardSwatches = () => {
            const container = document.getElementById('cardSwatches');
            container.innerHTML = "";
            window.cardColors.forEach(color => {
                const div = document.createElement('div');
                div.className = 'color-swatch' + (window.selectedCardColor === color ? ' selected' : '');
                div.style.background = color;
                div.onclick = () => {
                    window.selectedCardColor = color;
                    window.renderCardSwatches();
                };
                container.appendChild(div);
            });
        };

        function syncCloudRecipes(uid) {
            const q = query(collection(db, "recipes"), where("uid", "==", uid));
            onSnapshot(q, (snapshot) => {
                cloudRecipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.displayRecipes();
            });
        }

        window.saveRecipeToCloud = async () => {
            const docId = document.getElementById('editDocId').value;
            const data = {
                uid: currentUser.uid,
                name: document.getElementById('recipeName').value,
                image: document.getElementById('recipeImage').value,
                folder: document.getElementById('recipeFolderSelect').value,
                ingredients: document.getElementById('recipeIngredients').value,
                steps: document.getElementById('recipeSteps').value,
                cardBg: window.selectedCardColor
            };
            if (docId) await updateDoc(doc(db, "recipes", docId), data);
            else await addDoc(collection(db, "recipes"), data);
            window.closeModal();
        };

        window.deleteRecipe = async () => {
            const docId = document.getElementById('editDocId').value;
            if(docId && confirm("Are you sure you want to delete this recipe?")) {
                await deleteDoc(doc(db, "recipes", docId));
                window.closeModal();
            }
        };

        window.displayRecipes = () => {
            const list = document.getElementById('recipeList');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            list.innerHTML = "";
            let filtered = window.currentFolder === 'All' ? cloudRecipes : cloudRecipes.filter(r => r.folder === window.currentFolder);
            if(searchVal) filtered = filtered.filter(r => r.name.toLowerCase().includes(searchVal));
            
            filtered.forEach(r => {
                const imgTag = r.image ? `<img src="${r.image}" class="card-img" onerror="this.src='https://via.placeholder.com/350x180?text=No+Image'">` : '';
                
                const card = document.createElement('div');
                card.className = 'card';
                card.style.background = r.cardBg;
                card.onclick = () => window.openEditModal(r);
                card.innerHTML = `
                    ${imgTag}
                    <div class="card-body">
                        <div class="recipe-header">
                            <h3>${r.name}</h3>
                        </div>
                        
                        <div class="recipe-section">
                            <span class="section-label">Ingredients</span>
                            <div class="section-content">${r.ingredients}</div>
                        </div>
                        
                        <div class="recipe-section">
                            <span class="section-label">Instructions</span>
                            <div class="section-content">${r.steps}</div>
                        </div>
                        
                        <small style="color:#888; display:block; text-align:right; font-style:italic;">Edit</small>
                    </div>
                `;
                list.appendChild(card);
            });
        };

        window.openModal = () => {
            document.getElementById('recipeModal').style.display = "block";
            document.getElementById('modalTitle').innerText = "Create Recipe";
            document.getElementById('editDocId').value = "";
            document.getElementById('recipeName').value = "";
            document.getElementById('recipeImage').value = "";
            document.getElementById('recipeIngredients').value = "";
            document.getElementById('recipeSteps').value = "";
            document.getElementById('deleteRecipeBtn').style.display = "none";
            window.selectedCardColor = '#ffffff'; 
            window.renderCardSwatches();
        };

        window.openEditModal = (recipe) => {
            document.getElementById('recipeModal').style.display = "block";
            document.getElementById('modalTitle').innerText = "Edit Recipe";
            document.getElementById('editDocId').value = recipe.id;
            document.getElementById('recipeName').value = recipe.name;
            document.getElementById('recipeImage').value = recipe.image || "";
            document.getElementById('recipeFolderSelect').value = recipe.folder;
            document.getElementById('recipeIngredients').value = recipe.ingredients;
            document.getElementById('recipeSteps').value = recipe.steps;
            document.getElementById('deleteRecipeBtn').style.display = "block";
            window.selectedCardColor = recipe.cardBg || '#ffffff';
            window.renderCardSwatches();
        };
        
        window.closeModal = () => document.getElementById('recipeModal').style.display = "none";

        window.renderDashSwatches();
        window.renderFolderUI();
    </script>
</body>
</html>